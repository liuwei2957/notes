### 灰度发布

快速迭代，保证质量

#### 定义

1. 就是在黑和白之间平滑过渡的一种产品发布方式，根据某种规则，让一部分用户继续用原来的产品功能，一部分用户开始逐渐启用新功能，在过渡的过程中还会对产品做进一步的完善，灰度发布完成后，所有用户都将使用新功能
2. 金丝雀发布
3. A/B test

#### 架构设计

1. 上游服务接入客户端请求，根据下发的灰度配置将符合条件的请求转发到下游新旧版服务上
2. 配置中心，可以配置不同的灰度发布策略给上游服务

##### 协议设计

1. 定长header
2. 变长body
3. 设计初确定灰度发布字段（uid,token,ip,tag,mtest//全链路压测使用,cmd,sessionid,bodyLen）

##### 灰度策略

1. 单策略：uid/token/ip
2. 基于上下文灰度策略，多模块A/C同时灰度，tag

##### 实现

1. 上游服务nginx：本地部署agent,接收配置中心下发的灰度策略，更新nginx配置
2. rpc服务：集成配置中心sdk，接收下发的灰度策略，执行计划
3. 下游服务：新版本服务注册到注册中心，通过版本号控制是否开启

##### 涉及数据

1. 部分灰度：数据全量复制，双写
2. 全部灰度：双写
3. 灰度完成：去除双写

##### 开源系统

1. spring cloud灰度发布神器：Nepxion Discovery,服务注册和负载均衡增强中间件，包含了灰度发布

#### app灰度

##### 安卓

1. token取模
2. 灰度期间服务端通过接口控制
3. 灰度期间不提交应用市场，防止应用程序自动更新
4. 灰度完毕再提交应用市场

##### 苹果

1. app store提供灰度功能
2. 灰度发布机制为7天
3. 灰度发布遇到bug,可以暂停发布，已升级用户无法回退
4. 灰度阶段任何时候都可以100%直接发布

### 全链路压测设计

#### 压测工具

1. jmeter:用于对服务器，网络模拟巨大的负载，在不同压力类别下测试它们的强度和分析整体性能，支持分布式压测
2. tcpcopy:流量复制工具，能够把线上机器的流量导流到压测环境的机器上，为创造巨大压力情况，使用tcpdump录制请求，然后使用tcpcopy回放功能产生巨大的压力
3. apache ab：http

#### 极限标准

1. 机器load average不超过cpu核数*0.6
2. 服务器cpu占有率不超过（cpu核数*0.6)*100/机器部署的服务进程数
3. 网卡流量不超过网卡容量的60%，可能延时较大
4. 请求超时不超过十万分之一
5. qps不低于预估的85%

#### 压测实施方案条件

1. 为模拟更真实的环境，压测机器与线上机器同等配置，仿照线上机器的部署情况
2. 压测数据尽可能使用线上真实数据

#### 压测实施方案

##### 方案一

复用线上环境压测

1. 低峰期
2. 回放只读请求
3. 写请求无法压测，数据污染

##### 方案二

构造全套线上环境

1. 服务，数据，消息隔离，防止对用户骚扰
2. 读写都可以压测，成本高

##### 方案三

1. 把线上请求逐步分配至某一台服务器直到服务处理大到极限
2. 服务需要实时调整流量分配的能力
3. 服务运行信息从监控系统准实时获取

##### 方案四

全链路压测

1. 数据构造尽可能真实
2. 线上真实环境
3. 压测标识透传：跨线程：threadlocal对象，利用InheritableThreadLocal传递到子线程，跨进程：存储在定长header中
4. 压测服务隔离：在低峰期，对机器创建一个压测分组，隔出一批空闲的机器用于压测，将正常流量和压测流量在机器级别隔离
5. 压测数据隔离：使用影子表隔离数据，核心思想是使用线上同一个数据库，包括共享数据库中的内存资源，对于kv存储也是类似，对于mq可以根据选择在生产或消费端忽略带测试标识的消息

