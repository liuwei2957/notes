### 单体架构

app-nginx（反向代理）-多个tomcat-mysql

#### 优点

1. 业务场景简单，功能不复杂，研发人员较少
2. 适合创业公司初期
3. 性能要求苛刻（平均响应时间要求高，高频交易，跨多个进程网络交互延时）

#### 缺点

1. 系统耦合性高，技术选型单一，开发效率
2. 技术选型单一
3. 开发效率越来越低

#### 如何破局

数据库存储量大破局

1. 垂直拆分（分库，按照业务）
2. 水平拆分（分表，一个表拆分多个表）

架构同理（数据怎么拆，架构就怎么拆）

1. 垂直方向拆分（业务维度）
2. 水平方向拆分（功能维度，网关层-业务逻辑层-数据访问层）



### 水平分层架构

水平方向分成多个独立进程，每层逻辑解耦

app-nginx（反向代理）-网关层-业务逻辑层（多个service）-数据访问层（多个dao）-数据存储层（mysql）/ cache

#### 分层设计原则

1. 展示服务与网关服务分离，网关层吐的数据不包含展示逻辑，展示逻辑在app层处理（国际化）
2. 网关服务与业务逻辑服务分离
3. 业务逻辑服务与数据服务分离
4. 调用只能从下到下，业务逻辑层之间不能相互访问，直接访问数据访问层，防止循环调用，如果有重复代码，可以下沉为一个独立的服务

#### 网关层功能

1. 请求鉴权（有没有登录），网关鉴权是粗粒度，各个服务之间通过token或ip白名单判断是否有权限
2. 数据完整性检查（数据包定长header（userid,sessionid,cmd,bodyLength）+变长body），不处理具体的语义，检查定长header是否完整，进入网关层后数据传输协议改为rpc over tcp（tcp为长连接）（http短连接连接效率低，数据传输效率低），数据协议由json改为二进制的pb（二进制，压缩）
3. 协议转换（json-hashmap(String,Object)）
4. 路由转发，负载均衡（根据CMD转发到不同业务逻辑层）
5. 服务治理（限流，降级，熔断）

#### 数据访问层功能

rdbms（mysql）-nosql（mongodb/hbase，事务比较弱）-newsql（tidb，分布式关系型数据库）

1. 业务增删改查（批量）
2. ORM（mybatis）
3. sharding（分库分表）-下推到存储层
4. 屏蔽底层存储差异性（mysql/mongodb，redis）

#### 同/异步架构

异步目的：提升吞吐量，异步手段：消息队列，适用场景：读请求不适用，数据一致性要求弱的写请求可以，高并发场景，写之后马上读，读不到数据：把数据缓存到本地客户端，下次请求经过db，消息写失败：重试

1. 上游和下游之间加一个消息队列变为异步架构
2. 写mq是顺序写比较快，写db是随机写比较慢
3. 消息队列放app-nginx-网关是没有意义的，网关通过请求鉴权会过滤掉很多无意义数据，若放在nginx-网关会导致mq写入很多无意义数据，并且网关不会成为写入瓶颈
4. mq放网关和业务逻辑层之间

#### 缺点

1. 请求路径变长
2. 平均响应延迟变高（网络交互复杂）
3. 定位问题变得复杂化
4. 运维成本增加

#### 层次划分

1. 同步架构：网关层-业务逻辑层-数据访问层-数据存储层
2. 异步架构：网关层-异步消息队列层-业务逻辑层-数据访问层-数据存储层
3. nginx前可加netGW（sdn），对路由器做一层虚拟化

#### 水平同步架构全貌

1. app-dns（域名解析，域名-VIP）,netGW的ip
2. app请求cdn，获取静态资源（cdn（css，图片等））
3. cdn缓存没有命中，cdn请求nginx，获取css,html,js等静态资源（nginx）
4. cdn缓存没有命中，cdn请求对象存储，获取图片等数据，object storage（图片，音视频等）fastdfs，ceph
5. 通过VIP获取动态数据

### 微服务架构

既按垂直方向拆分，又按水平方向拆分，目的：项目快速迭代，持续交付

#### 拆分维度

1. 业务架构
2. 组织架构，按照事业部组织

#### 适用场景

1. 需求层面：需求变化比较频繁，需要快速迭代，持续交付，内部的OA系统，erp系统就不适合
2. 性能层面：吞吐量高，对平均响应延迟要求低
3. 数据一致性层面：最终一致性

#### 微服务架构不是银弹

1. 业务关注服务间通信，业务迭代速度变慢（需要引入jar包等方式）
2. 基础设施组件升级困难，影响基础设施团队的交付能力和速度

### 服务网格架构

服务网格是一个基础设施层，用于处理服务间通信，在实践中，服务网格通常实现为一组轻量级网络代理，它们与应用程序部署在一起，而对应用程序透明，应用程序通过sidecar进行通信，应用程序与sidecar必须部署在同一台机器上（不需要考虑负载均衡，重试，路由，注册中心等问题），否则又会出现应用程序与sidecar之间的通信问题

#### 优点

1. service mesh独立进程，独立升级
2. 业务团队专注于业务逻辑本身
3. 一套基础设施支持多语言开发（应用程序和sidecar之间通过tcp，pb进行通信）
4. 业务团队和基础设施团队物理解耦